<!DOCTYPE HTML>
<!--
	Epilogue by TEMPLATED
	templated.co @templatedco
	Released for free under the Creative Commons Attribution 3.0 license (templated.co/license)
-->
<html>
	<head>
		<title>Banking with Friends</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<link rel="stylesheet" href="assets/css/main.css" />
		<style> 
			div.friend {
				background-color: white; 
				padding: 1em;
				width: 30em;
				text-align: center;
			}
			
			div.pending {
				background-color: pink;
			}
	
			div.imageholder {
				width: 75px;
				height: 75px;
				display: inline-flex;
				align-content: center;
				background-color: green;
				align-items: center;
				justify-content: center;
			}
	
			div.imageholder.green {
				background-color: green;
			}
	
			div.imageholder.yellow {
				background-color: yellow;
			}
	
			div.imageholder.red {
				background-color: red;
			}
	
			p.balance {
				display: none; 
			}
			
			input.transaction_amount {
				display: none;
			}
			
			p.chatter {
				font-size: 1.5em;
			}
			
			input[type="button"] {
				min-width: 3em;
				padding: 0 0.5em;
			}
			
			div.imageholder img {
				max-width: 50px; 
				
			}
			
			input.transaction_amount {
				margin: 1em 0;
			}
			
			#listemhere {
				display: flex;
				flex: 1 1 auto;
				flex-wrap: wrap;
				justify-content: center;
			}
			
		</style>
	</head>
    
	<body>
        <!-- Nav -->
			<nav id="nav">
				<ul class="links">
					<li><a href="index.html">Home</a></li>
					<li><a href="newcustomers.html">New Customers</a></li>
					<li><a href="listcustomers.html">List of Customers</a></li>
                    <li><a href="contact.html">Contact Us</a></li>
				</ul>
			</nav>
        
		<!-- Header -->
			<header id="header" class="alt">
                <a href="#nav" style="position:absolute;right:10px;top:10px;">Menu</a>
				<div class="inner">
					<h1>The Unnamed Website</h1>
					<p>Banking with friends?</p>
				</div>
			</header>

		<!-- Wrapper -->
			<div id="wrapper">

				<!-- Banner -->
					<section id="intro" class="main">
						<h2>Create a new customer</h2>
                <form>
                    <input id="custFName" type="text" placeholder="First Name" /> 
                    <input id="custLName" type="text" placeholder="Last Name" /> 
                    <input id="custStreetName" type="text" placeholder="Street Name" /> 
                    <input id="custStreetNumber" type="text" placeholder="Street Number" /> 
                    <input id="custCity" type="text" placeholder="City" /> 
                    <input id="custState" type="text" placeholder="State" /> 
                    <input id="custZip" type="text" placeholder="Zip" />
                </form>
                    <input id="custSubmit" type="button" value="Submit"/>  

					</section>
					
					<!-- Items -->
					<section class="main items">
						<article class="item">
							<header>
								<a href="#"><img src="images/pic01.jpg" alt="" /></a>
								<h3>What is the Unnamed website?</h3>
							</header>
							<p>This webpage uses CapitalOne's API to allow the user to manage his bank accounts, budget and let his friends know of how much he has spent from his current budget.</p>
							<ul class="actions">
								<li><a href="#" class="button">More</a></li>
							</ul>
						</article>
						<article class="item">
							<header>
								<a href="#"><img src="images/pic02.jpg" alt="" /></a>
								<h3>Who is it for?</h3>
							</header>
							<p>Our target market is mainly students. We wanted a platform where budgeting can also be more sociable. This page allows the user to also interact with their friend's budgets too.</p>
							<ul class="actions">
								<li><a href="#" class="button">More</a></li>
							</ul>
						</article>
						<article class="item">
							<header>
								<a href="#"><img src="images/pic03.jpg" alt="" /></a>
								<h3>How do you use it?</h3>
							</header>
							<p>Each user will simply have  a budget, which will reset once a month (on a day of their choosing) and they will have 'indicators' which will let their friends know how much of their budget they have spent for the month.</p>
							<ul class="actions">
								<li><a href="#" class="button">More</a></li>
							</ul>
						</article>
						<article class="item">
							<header>
								<a href="#"><img src="images/pic04.jpg" alt="" /></a>
								<h3>Item 4</h3>
							</header>
							<p>Too sleepy to come up with something else...</p>
							<ul class="actions">
								<li><a href="#" class="button">More</a></li>
							</ul>
						</article>
					</section>
					
					<section class="main">
					<div id="listemhere"></div>
				</section>

				

				<!-- CTA -->
					<section id="cta" class="main special">
						<h2>Try it out!</h2>
						<p>Click below to get started? ...</p>
						<ul class="actions">
							<li><a href="#" class="button big">Get Started</a></li>
						</ul>
					</section>

				<!-- Main -->
				<!--
					<section id="main" class="main">
						<header>
							<h2>Lorem ipsum dolor</h2>
						</header>
						<p>Fusce malesuada efficitur venenatis. Pellentesque tempor leo sed massa hendrerit hendrerit. In sed feugiat est, eu congue elit. Ut porta magna vel felis sodales vulputate. Donec faucibus dapibus lacus non ornare. Etiam eget neque id metus gravida tristique ac quis erat. Aenean quis aliquet sem. Ut ut elementum sem. Suspendisse eleifend ut est non dapibus. Nulla porta, neque quis pretium sagittis, tortor lacus elementum metus, in imperdiet ante lorem vitae ipsum. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Etiam eget neque id metus gravida tristique ac quis erat. Aenean quis aliquet sem. Ut ut elementum sem. Suspendisse eleifend ut est non dapibus. Nulla porta, neque quis pretium sagittis, tortor lacus elementum metus, in imperdiet ante lorem vitae ipsum. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas.</p>
					</section>
				-->

				<!-- Footer -->
					<footer id="footer">
						<ul class="icons">
							<li><a href="#" class="icon fa-twitter"><span class="label">Twitter</span></a></li>
							<li><a href="#" class="icon fa-facebook"><span class="label">Facebook</span></a></li>
							<li><a href="#" class="icon fa-instagram"><span class="label">Instagram</span></a></li>
							<li><a href="#" class="icon fa-linkedin"><span class="label">LinkedIn</span></a></li>
							<li><a href="#" class="icon fa-envelope"><span class="label">Email</span></a></li>
						</ul>
						<p class="copyright">&copy; Untitled. Design: <a href="https://templated.co">TEMPLATED</a>. Images: <a href="https://unsplash.com">Unsplash</a>.</p>
					</footer>

			</div>

		<!-- Scripts -->
			<!--<script src="assets/js/jquery.min.js"></script>-->
			<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
			<script src="assets/js/skel.min.js"></script>
			<script src="assets/js/util.js"></script>
			<script src="assets/js/main.js"></script>
			
						<script>
{
	let povertyLevel = 300;
	let yellowLevel = 500;


	// Bind the buttons
	$('#custSubmit').on('click', () => submitCust()); 
	
	//$('#listSubmit').on('click', () => listCusts());
	
	// Using the HTML Inputs, create a new customer
	function submitCust(){
		api('customers', 'POST', 
			{
				'first_name': $('#custFName').val(),
				'last_name': $('#custLName').val(),
				'address': {
					'street_number': $('#custStreetNumber').val(),
					'street_name': $('#custStreetName').val(),
					'city': $('#custCity').val(),
					'state': $('#custState').val(),
					'zip': $('#custZip').val()
				}
			},
			(resp) => {
				// They'll need a checing account
				createAccount(resp.objectCreated._id);
				let storedFriendos = JSON.parse(localStorage.getItem('frands'));
				if(typeof storedFriendos == 'object'){
					storedFriendos.push({name: $('#custFName').val() + ' ' + $('#custLName').val(), pic: 'images/facebook-default-no-profile-pic.jpg'});
					localStorage.setItem('frands', JSON.stringify(storedFriendos));
				}
				// Refresh the listing to show the new account. 
				listCusts();
			}
		);
	}
	
	// We only have a name? No problem
	function quickSubmitCustomer(fname, lname, callback){
		// Fudge the address, and simply do not display that stuff later
		api('customers','POST',{
			'first_name':fname,
			'last_name':lname,
			'address': {
				'street_number':'1234',
				'street_name':'Fake St',
				'city':'Fakeville',
				'state':'OH',
				'zip':'83530'
			} 
		}, 
		(resp) => {
			// Make them a checking account
			createAccount(resp.objectCreated._id, (response)=>{
				// pass the customer ID (not the account ID) back out
				callback(resp.objectCreated._id); 
			}); 
		});
	}
	
	// Have we scraped Facebook for friends? Has this been stored?
	function listCusts(){
		if(localStorage.getItem('frands')){
			listFriends();
		} else {
			listGenerics();
		}
	}
	
	// Display friends from the local storage
	// These were scraped from Facebook during the login process
	function listFriends(){ 
		let friendos = JSON.parse(localStorage.getItem('frands'));
		// we only want some
		//friendos = friendos.slice(10); 
		$('#listemhere').html('');
		for(let friend of friendos){
			//render the html
			$('#listemhere').append
				(`<div class="friend">
					<p>${friend.name}</p>
					<div class="imageholder">
						<img class="friend_photo" src="${friend.pic}" />
					</div>
				</div>`);
			// This Facebook friend might not have a customer ID yet
			// Save a reference to this DOM element if we need to give it an ID later
			let lastP = $('#listemhere div.friend:last-child'); 
			// However, the friend may have already been assigned a customer ID
			// If it has been, we can just give that DOM the id right now
			if(friend.hasOwnProperty('cust_id')){
				lastP.attr('id',friend.cust_id);
			} else {
				// Hit the API to make a new customer entry
				// we're just splitting the name by the space in the middle
				// This is a BAD BAD thing to do, very hostile toward people with 
				// non-anglo naming schemes, but quick and dirty
				quickSubmitCustomer(friend.name.split(' ')[0], friend.name.split(' ')[1],
					(response)=>{
						let id = response;
						lastP.attr('id', id);
						friend.cust_id = id;
						// yeah, I rewrite localstorage up to 10 times per pageload
						// much easier than figuring out when the last
						localStorage.setItem('frands', JSON.stringify(friendos));
					});
			}
			waitForReady(()=>{
					listCustBalances(friend.cust_id);
			});
			
		}
	}
	
	function waitForReady(cb){
		if($('div.friend:not([id])').length>0){
			setTimeout(()=>waitForReady(cb),1000);
		} else {
			cb();
		}
	}
	
	//pull randos from the API that we've created
	function listGenerics(){
		api('customers', 'GET', '', (response) => {
			$('#listemhere').html('');
			for(let customer of response.slice(10)){
				$('#listemhere').append('<p id="'+customer._id+'">'+customer.first_name+' '+customer.last_name +
					'<p/><p>'+customer.address.street_number+' '+customer.address.street_name +
					' '+customer.address.city+', '+customer.address.state+' '+customer.address.zip
					+'</p>');
				listCustBalances(customer._id);
			}
		});
	}
	
	function listCustBalances(id){
		
		api('customers/'+id+'/accounts','GET','',function(response){
			for(let account of response){
				$(`#${id}`).append(
					`<p class="balance">${account.balance}</p>
					<input type="text" class="transaction_amount" placeholder="transaction" />
					<input type="button" value="+" class="transaction_add" />
					<p class="chatter"></p>`
				);  
				
				if(localStorage.getItem('transact-flags')){
					let transactFlags = JSON.parse(localStorage.getItem('transact-flags')); 
					if(transactFlags[id] != account.balance){
						transactFlags[id] = undefined; 
						localStorage.setItem('transact-flags',JSON.stringify(transactFlags));
					} else {
						$(`#${id}`).addClass('pending');
						registerForAjaxPending(id);
						for(let input of $(`#${id} input`))
							$(input).attr('disabled','');
					}
				}
				
				$('#'+id).find('.transaction_add').one('click', (evt)=> {
					//transact($(evt.target).parent().find('.transaction_amount').val(), account._id, id);
					$('#'+id).find('.transaction_amount').css('display','block');
					$(evt.target).attr('value','Send');
					$('#'+id).find('.transaction_add').on('click', (evt)=> {
						transact($(evt.target).parent().find('.transaction_amount').val(), account._id, id);
					});
				});
				
				//$('#'+id).find('.transaction_remove').on('click', (evt)=> {
					//transact(-parseInt($(evt.target).parent().find('.transaction_amount').val()), account._id, id);
				//});
				
				colorBoxes(id, account.balance);
			}
		});
	}
	
	function colorBoxes(id, money){
		$(`#${id} p.chatter`).text('');
		$(`#${id} div.imageholder`).attr('class','imageholder');
		if(money>yellowLevel ){
			$(`#${id} div.imageholder`).addClass('green');
		} else if (money>povertyLevel){
			$(`#${id} div.imageholder`).addClass('yellow');
		} else {
			$(`#${id} div.imageholder`).addClass('red');
			$(`#${id} p.chatter`).text(generateChatter(money));
		}	
	}
	
	function generateChatter(dollaz){
		if(Math.round(Math.random())) return '';
		let amountNeeded = yellowLevel - dollaz; 
		let days = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
		let times = ['Morning','Afternoon','Evening','Night','Noon','Midnight'];
		let day = days[Math.floor(Math.random()*7)];
		let time = times[Math.floor(Math.random()*6)];
		let openers = [
			`I'm going to need all my mates to give me £${amountNeeded} if i'm going out on ${day} ${time}.`,
			`Listen, I'd love to join you on ${day} ${time} but I just can't do it without... Say... £${amountNeeded}?`,
			`Heyyyy! Let's get faced on ${day} ${time}! Thing is, though, I could really use £${amountNeeded}...`,
			`Can't drink if I can't eat. Hook me up with £${amountNeeded}?`
		];
		
		return openers[Math.floor(Math.random()*openers.length)];
	}
	
	function createAccount(id, callback=(response)=>{console.log(response)}){
		api('customers/'+id+'/accounts','POST', {
			"type":"Checking",
			"rewards":0,
			"nickname":"auto-created",
			"balance": Math.floor(Math.random()*750)
		}, (response) => {
			callback(response);
		}); 
	}
	
	function transact(amount, id, custid) {
		api('accounts/'+id+'/'+((amount>0)?'deposits':'withdrawals'), 'POST', {
			"medium": "balance",
			"transaction_date": "2016-11-20",
			"amount": parseFloat(Math.abs(amount)),
			"description": "Hand-built transaction"
		}, (response) => {
			makePending(custid);
			
		});
	}
	
	function registerForAjaxPending(id){
		api('customers/'+id+'/accounts', 'GET', {}, (response)=> {
			if(localStorage.getItem('transact-flags')){
				var transactFlags = JSON.parse(localStorage.getItem('transact-flags')); 
			} else {
				var transactFlags = {}
			}
			
			if(response[0].balance != transactFlags[id]){
				$(`#${id}`).removeClass('pending');
				$(`#${id} p.balance`).text(response[0].balance);
				colorBoxes(id, response[0].balance);
				for(let input of $(`#${id} input`))
					$(input).removeAttr('disabled');
			} else {
				setTimeout(()=>registerForAjaxPending(id), 5000);
			}
		});
	}
	
	function makePending(id){
		// detecting whether a transaction is pending
		if(localStorage.getItem('transact-flags')){
			var transactFlags = JSON.parse(localStorage.getItem('transact-flags')); 
		} else {
			var transactFlags = {}
		}
		transactFlags[id] = $(`#${id} p.balance`).text(); 
		console.log(`#${id} input`);
		for(let input of $(`#${id} input`))
			$(input).attr('disabled','');
		localStorage.setItem('transact-flags', JSON.stringify(transactFlags));
		$(`#${id}`).addClass('pending'); 	
		registerForAjaxPending(id);
	}
	
	function api(endpoint, method, data, response){
		$.ajax({
			url: 'http://api.reimaginebanking.com/'+endpoint+'?key=6021ab09d195f722f7c5619957e8679d',
			method: method,
			contentType: 'application/json',
			data: JSON.stringify(data),
			success: (text)=>response(text)
		});
	}
	
	listCusts();
}
			</script>

	</body>
</html>
